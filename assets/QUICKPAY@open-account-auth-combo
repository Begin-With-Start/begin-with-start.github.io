{"time":"0019","tplId":"QUICKPAY@open-account-auth-combo","publishVersion":"150924","tag":"QUICKPAY","name":"open-account-auth-combo","data":{"tag":"html","children":[{"tag":"head","children":[{"tag":"meta","src":"AlipaySDK.bundle/amc.i18n","type":"i18n"},{"tag":"script","src":"AlipaySDK.bundle/amc.js"},{"tag":"link","rel":"stylesheet","href":"AlipaySDK.bundle/amc.css"},{"tag":"script","children":[{"text":"// 鸟巢常用方法二次封装\n    var ap = {\n      /**\n       * ap.call invoke通用处理，向后兼容\n       * ap.call('alert', {op}, function() { callback func });\n       */\n      call: function(api, op, cb) {\n        document.invoke(api, op, function (result) {\n          cb && cb(result);\n        });\n      },\n      /**\n       * showToast 提示\n       ap.showToast({\n          content: contents[type],\n          type: type\n        }, function() { callback func });\n       */\n      showToast: function(op, cb) {\n        var dop = typeof(op) !== 'object' ? { content: op }: op;\n        document.toast({\n          text : dop.content || '',\n          type : dop.type || 'none'\n        }, function() {\n          cb && cb(result);\n        });\n      },\n\n      /**\n       * alert 提示框\n       * ap.alert({\n       *   'title': '',\n       *   'message': '',\n       *   'button': ''\n       * }, function() { callback func });\n       */\n      alert: function(op, cb) {\n        var dop = typeof(op) !== 'object' ? { message: op }: op;\n        document.invoke('alert', {\n          \"title\": dop.title || '',\n          \"message\": dop.message || '',\n          \"okButton\": dop.button || '{{confirm_btn}}'\n        }, function (result) {\n          cb && cb(result);\n        });\n      },\n      /**\n       * confirm 确认框\n       * ap.confirm({\n       *   'title': '',\n       *   'message': '',\n       *   'okButton': ''\n       *   'cancelButton': ''\n       * }, function() { callback func });\n       */\n      confirm: function(op, cb) {\n        var dop = typeof(op) !== 'object' ? { message: op }: op;\n        document.invoke('alert', {\n          \"title\": dop.title || '',\n          \"message\": dop.message || '',\n          \"okButton\": dop.okButton || '{{confirm_btn}}',\n          \"cancelButton\": dop.cancelButton || '{{cancel}}'\n        }, function (result) {\n          cb && cb(result);\n        });\n      },\n      /**\n       * 设置结果给inside（无交互反馈，用户无感知）\n        ap.setResult({op});\n       */\n      setResult: function(op) {\n        document.invoke('setResult', op);\n      },\n      /**\n       * 核身\n        ap.verifyIdentity({op}, function() { callback func });\n       */\n      verifyIdentity: function(op, cb) {\n        document.invoke('verifyIdentity', op, function(result) {\n          cb && cb(result);\n        });\n      },\n      /**\n       * exitApp 退出app\n        ap.exitApp();\n       */\n      exitApp: function() {\n        document.submit({ 'action': { 'name': 'loc:exit' } });\n      },\n      /**\n       * pushWindow 新开页面\n       ap.pushWindow();\n       */\n      showPage: function(op, cb) {\n        document.invoke('showPage', op, function(result) {\n          cb && cb(result);\n        });\n      },\n      /**\n       * popWindow 返回上一页\n        ap.popWindow();\n       */\n      popWindow: function() {\n        document.submit({ 'action': { 'name': 'loc:back' } });\n      },\n      /**\n       * rpc\n       * eg:\n        ap.rpc({\n          operationType: 'com.alipay.basement.gateway.endpoint',\n          headers: {\n            'x-basement-operation': 'com.alipay.h5data.fengdie.get'\n          },\n          requestData: [{\n            path: 'pucprod-h5data/common/config-h5data'\n          }]\n        }, function (result) {\n          ap.alert(JSON.stringify(result))\n        });\n       */\n      rpc: function(op, cb) {\n        document.invoke('rpc', op, function(result) {\n          setTimeout(function() {\n            cb && cb(result);\n          }, 1);\n        });\n      }\n    };\n\n    // 别名\n    var create = amc.fn.create;\n    var getTag = amc.fn.getById;\n    var hide = amc.fn.hide;\n    var show = amc.fn.show;\n\n    var rpcData = amc.rpcData;\n\n    var pageTitle = rpcData.pageTitle || '';\n    var logoPng = rpcData.logoUrl || '';\n    var partnerName = rpcData.authTitle || '';\n    var pid = rpcData.partnerId || '';\n\n    var account = rpcData.hiddenLogonId || '';\n    var accountInfoTitle = '支付宝账号：' + account;\n\n    var applyToken = rpcData.applyToken;\n\n    var authItemList = rpcData.authItemList;\n\n    // 授权文案区分单授权和聚合授权\n    var authInfoTitle = authItemList && authItemList.length > 1 ? '你同意 ' + partnerName + ' 获取以下权限' : '您同意将以下信息授权给 ' + partnerName;\n\n    var authOptionList = rpcData.authOptionList || '';\n    var authTypeText = '{{auth}}';\n    var canAuth = true;\n\n    // 初始化\n    function init() {\n      try {\n        initUI();\n        if (amc.fn.logPageInit) {\n          amc.fn.logPageInit(true);\n        }\n      } catch (e) {\n        if (amc.fn.logPageInit) {\n          amc.fn.logPageInit();\n        }\n      }\n    }\n\n    function initUI() {\n      // spm埋点 - 页面曝光\n      amc.fn.spmPageCreate('a259.b8576', { pid: pid });\n\n      var nav = amc.fn.navBack(false, pageTitle, null, null, onBack, null);\n      getTag('body').insertBefore(nav, getTag('mainBody'));\n\n      getTag('merchantLogo').src = logoPng;\n      getTag('merchantLogo').defaultvalue = amc.path + 'alipay_msp_auth_default_logo';\n\n      getTag('alipayLogo').src = amc.path + 'alipay_msp_auth_alipay_logo';\n      getTag('arrow').src = amc.path + 'alipay_msp_side_relate';\n\n      getTag('btnText').innerText = amc.fn.i18nPlaceholderReplace('{{confirm_sth}}', authTypeText);\n      getTag('btnText').style.maxWidth = window.innerWidth - 70;\n\n      getTag('authInfoTitle').innerText = authInfoTitle;\n\n      var accountInfo = getTag('accountInfo');\n      accountInfo.innerText = accountInfoTitle;\n      accountInfo.style.maxWidth = window.innerWidth - 30;\n\n      // 创建授权列表\n      if (authItemList) {\n        var authLists = getTag('authLists');\n        for (var i = 0; i < authItemList.length; i++) {\n          var authItemsBox = create('div', 'amc-v-box auth-items-box amc-bg-white', authLists);\n          var authItemLineTop = create('div', 'amc-1px-line', authItemsBox);\n          if (authItemList.length > 1) {\n            var authTitle = create('div', 'auth-title', authItemsBox);\n          }\n\n          var authItems = create('div', 'auth-items amc-v-box', authItemsBox);\n          var authItemLineBottom = create('div', 'amc-1px-line', authItemsBox);\n\n          // 授权名称\n          var authTitleText = create('label', 'auth-title-text', authTitle);\n          authTitleText.innerText = authItemList[i].authOptionTitle || 'authTitle';\n\n          // 授权细则\n          var tmpList = authItemList[i].authTextList || [];\n          for (var j = 0; j < tmpList.length; j++) {\n            var authItem = create('div', 'auth-item', authItems);\n            var dot = create('div', 'auth-dot', authItem);\n            var label = create('label', 'auth-item-text', authItem);\n            label.innerText = tmpList[j];\n          }\n        }\n\n        show('authLists');\n      }\n\n      // 显示协议\n      if (authOptionList.length === 0) {\n        hide('protocolArea');\n      }\n\n      // 显示底部提示文案\n      if (rpcData.insideTip) {\n        show('insideTipBox');\n        getTag('insideTip').innerText = rpcData.insideTip;\n      }\n\n      getTag('mainBody').style.height = amc.specs.bodyHeight;\n\n      getTag('agree').innerText = '确认授权即表示同意';\n      show('authSceneTipBox');\n      show('skipAuthBox');\n\n      getTag('authSceneTip').innerText = 'Auth_Inside';\n    }\n\n    // 获取选项列表\n    function getOptionList(optionList, key) {\n      var list = [];\n      for (var idx in optionList) {\n        list.push(optionList[idx]);\n      }\n      return list;\n    }\n\n    // 打开协议\n    function showProtocol() {\n      for (var i = 0; i < authOptionList.length; i++) {\n        authOptionList[i]['text'] = authOptionList[i]['agreementName'] || '{{serve_protocol}}';\n        authOptionList[i]['url'] = authOptionList[i]['agreementUrl'];\n      }\n      amc.fn.showProtocolList(authOptionList);\n      amc.fn.spmClick('a259.b8576.c20509.d37802', { pid: pid });\n    }\n\n    // 验密请求\n    function onSubmit() {\n      amc.fn.spmClick('a259.b8576.c20509.d37803', { pid: pid });\n\n      if (!canAuth) {\n        return;\n      }\n\n      amc.fn.playGif(getTag('gifImg'), amc.res.loading);\n      getTag('btnText').innerText = '{{confirming_upgrade}}';\n\n      // 获取核身token\n      ap.rpc({\n        operationType: 'alipay.payauth.sdk.aggregation.sign.verify',\n        requestData: {\n          applyToken: applyToken\n        }\n      }, function (result) {\n        if (result.success && result.verifyId) {\n          var securityId = result.securityId; // 查授权结果需要\n          var verifyIdentityParmas = {\n            verifyId: result.verifyId,\n            isNeedFP: 'true'\n          };\n          if (result.bizId) {\n            verifyIdentityParmas.bizId = result.bizId; // 业务标识，目前服务端没下发，未来下发无需修改代码。by @叶清\n          }\n          // 拉起核身\n          ap.verifyIdentity(verifyIdentityParmas, function(result) {\n            // 核身成功\n            if (result.code === '1000') {\n              ap.rpc({\n                operationType: 'alipay.payauth.sdk.aggregation.sign.confirm',\n                requestData: {\n                  applyToken: applyToken,\n                  securityId: securityId\n                }\n              }, function (result) {\n                // sdk设置结果\n                if (result.sdkMobileResult) {\n                  ap.setResult(result.sdkMobileResult);\n                }\n                else {\n                  ap.setResult({\n                    \"sdkMobileResult\": {\n                      \"success\": false,\n                      \"errorCode\": result.errorCode || \"SYSTEM_ERROR\",\n                      \"errorMsg\": result.errorMsg || \"系统异常\"\n                    }\n                  });\n                }\n\n                // 展示授权结果页\n                if (result.showResultPage) {\n                  result.pid = pid;\n                  ap.showPage({\n                    tplid: result.tplId,\n                    tpl: result.tpl,\n                    data: result\n                  });\n                }\n                else {\n                  if (result.success) {\n                    ap.alert({\n                      'message': '授权成功'\n                    }, function () {\n                      ap.exitApp();\n                    });\n                  } else {\n                    amc.fn.spmClick('a259.b8576.c20510.d37385', { pid: pid });\n                    ap.alert(result.errorMsg || '授权失败，请重试');\n                  }\n                }\n              });\n            }\n            // 非用户取消状态，核身失败\n            else if (result.code !== '1003') {\n              amc.fn.spmClick('a259.b8576.c20510.d37386', {\n                pid: pid,\n                errorCode: result.code,\n                message: result.message\n              });\n              ap.alert(result.message || '校验失败，请重试');\n            }\n          });\n        } else {\n          amc.fn.spmClick('a259.b8576.c20510.d37387', { pid: pid });\n\n          ap.setResult({\n            \"sdkMobileResult\": {\n              \"success\": false,\n              \"errorCode\": result.errorCode || result.error || \"SYSTEM_ERROR\",\n              \"errorMsg\": result.errorMsg || result.errorMessage || \"系统异常\"\n            }\n          });\n          ap.alert(result.errorMsg || result.errorMessage || \"系统异常\");\n        }\n      });\n\n      setTimeout(resetBtn, 3000);\n      canAuth = false;\n    }\n\n    // 重置按钮\n    function resetBtn() {\n      amc.fn.playGif(getTag('gifImg'), '');\n      getTag('btnText').innerText = amc.fn.i18nPlaceholderReplace('{{confirm_sth}}', authTypeText);\n      canAuth = true;\n    }\n\n    // Android硬返回\n    function onKeyDown() {\n      if (event.which == 4) {\n        onBack();\n      }\n    }\n\n    // 退出&暂不授权\n    function onBack() {\n      amc.fn.spmClick('a259.b8576.c20509.d37804', { pid: pid });\n      ap.confirm({\n        'message': '{{confirm_exit}}',\n        'okButton': '{{confirm_btn}}',\n        'cancelButton': '{{cancel}}'\n      }, function(result) {\n        if (result.ok) {\n          ap.setResult({\n            \"sdkMobileResult\": {\n              \"success\": false,\n              \"errorCode\": \"CANCEL\",\n              \"errorMsg\": \"取消\"\n            }\n          });\n          ap.exitApp();\n        }\n      });\n    }","tag":"text"}]},{"tag":"style","children":[{"text":".agree-label {\n      max-width: 150px;\n    }\n\n    .inside-tip-box {\n      min-height: 63px;\n      padding: 5px 15px 24px 15px;\n      justify-content: flex-end;\n    }\n\n    .inside-tip {\n      font-size: 13px;\n      color: #888;\n    }\n\n    .top-bg {\n      background-color: #108EE9;\n      padding: 30px 15px;\n    }\n\n    .account-info {\n      font-size: 15px;\n      color: #fff;\n      opacity: 0.8;\n    }\n\n    .auth-info-title {\n      font-size: 15px;\n      color: #000;\n    }\n\n    .pd-lr {\n      padding-left: 15px;\n      padding-right: 15px;\n    }\n\n    .auth-items-box {\n      margin-top: 10px;\n    }\n\n    .auth-title {\n      padding: 15px 15px 0 15px;\n    }\n\n    .auth-title-text {\n      font-size: 16px;\n    }\n\n    .auth-items {\n      padding: 4px 15px 15px 15px;\n    }\n\n    .auth-item {\n      margin-top: 6px;\n      align-items: center;\n      font-size: 15px;\n    }\n    .auth-dot {\n      height: 4px;\n      width: 4px;\n      border-radius: 2px;\n      background-color: #888;\n      margin-right: 6px;\n    }\n    .auth-item-text {\n      color: #888;\n      width: 90%;\n    }\n\n    .btn-box {\n      padding-top: 30px;\n      padding-bottom: 15px;\n    }\n\n    .auth-info-title-box {\n      padding: 15px;\n    }\n\n    .font-m {\n      font-size: 15px;\n    }\n\n    .margin-r-xs {\n      margin-right: 6px;\n    }\n\n    .btn-primary {\n      background-color: #108ee9;\n      border: 0;\n      border-radius: 4px;\n      color: #fff;\n      font-size: 18px;\n      height: 43px;\n      max-height: 43px;\n      min-height: 43px;\n      flex: 1.0;\n    }\n\n    .btn-primary:active {\n      background-color: #1284D6;\n      color: #fff;\n    }\n\n    .btn-primary:disabled {\n      background-color: #ebebf0;\n      color: #d2d2d2;\n    }\n\n    .btn-img {\n      width: 24px;\n      height: 24px;\n      margin-right: 8px;\n    }\n\n    .protocol-area {\n      padding-top: 18px;\n    }\n\n    .skip-auth-box {\n      padding: 0px 15px 0px 15px;\n      margin-bottom: 32px;\n      justify-content: center;\n      margin-top: -18px;\n      height: 18px;\n    }\n\n    .auth-scene-box {\n      padding: 0px 15px 0px 15px;\n      justify-content: center;\n      height: 18px;\n    }\n\n    .auth-scene-tip {\n      font-size: 10px;\n      text-align: right;\n      color: #CCC;\n    }\n\n    .logo-box {\n      width: 54px;\n      height: 54px;\n      border-radius: 10px;\n      background-color: #57AEEC;\n    }\n\n    .logo {\n      width: 50px;\n      border-radius: 10px;\n      height: 50px;\n    }\n\n    .arrow {\n      width: 29.83px;\n      height: 29.83px;\n      margin: 0px 16px;\n    }\n\n    .account-box {\n      margin-top: 9.5px;\n    }","tag":"text"}]}]},{"id":"body","onload":"init()","tag":"body","children":[{"id":"mainBody","tag":"div","children":[{},{"id":"banner","tag":"div","children":[{"tag":"div","children":[{"tag":"div","children":[{"id":"merchantLogo","tag":"img","css":"logo"}],"css":"logo-box amc-flex-center"},{"id":"arrow","tag":"img","css":"arrow"},{"tag":"div","children":[{"id":"alipayLogo","tag":"img","css":"logo"}],"css":"logo-box amc-flex-center"}],"css":"amc-flex-center"},{"tag":"div","children":[{"id":"accountInfo","tag":"label","css":"account-info amc-ellipsis"}],"css":"amc-justify-center account-box"}],"css":"top-bg amc-v-box"},{},{"tag":"div","children":[{"tag":"div","children":[{"id":"authInfoTitle","tag":"label","css":"auth-info-title amc-flex-1 amc-ellipsis-2-line"}],"css":"auth-info-title-box amc-bg-white"},{"tag":"div","css":"amc-1px-line"},{},{"id":"authLists","tag":"div","css":"amc-v-box amc-hidden"}],"css":"amc-v-box"},{"tag":"div","children":[{},{"id":"protocolArea","tag":"div","children":[{"id":"agree","tag":"label","children":[{"text":"{{agree}}","tag":"text"}],"css":"agree-label amc-ellipsis-2-line font-m margin-r-xs"},{"id":"protocol","tag":"label","children":[{"text":"{{serve_protocol}}","tag":"text"}],"onclick":"showProtocol()","css":"font-m amc-theme-color amc-flex-1 amc-ellipsis-2-line"}],"css":"pd-lr protocol-area"},{"id":"container","tag":"div","children":[{"id":"confirmBtn","tag":"div","children":[{"id":"gifImg","tag":"embed","type":"MQPPayGifView","css":"btn-img amc-hidden"},{"id":"btnText","tag":"label","children":[{"text":"{{confirm_auth}}","tag":"text"}],"css":"amc-btn-text-color amc-font-super-l amc-btn-ellpsis"}],"onclick":"onSubmit()","css":"btn-primary amc-justify-center amc-align-center"}],"css":"pd-lr btn-box"}],"css":"amc-v-box"},{"id":"authSceneTipBox","tag":"div","children":[{"id":"authSceneTip","tag":"label","css":"auth-scene-tip"}],"css":"auth-scene-box amc-v-box amc-hidden"},{"id":"skipAuthBox","tag":"div","children":[{"tag":"label","children":[{"text":"暂不授权","tag":"text"}],"onclick":"onBack()","css":"amc-theme-color amc-text-center amc-font-m"}],"css":"skip-auth-box amc-hidden"},{},{"id":"insideTipBox","tag":"div","children":[{"id":"insideTip","tag":"label","css":"inside-tip amc-text-center amc-ellipsis-2-line"}],"css":"amc-v-box amc-flex-1 inside-tip-box amc-hidden"},{"tag":"div","css":"amc-iphone-x-pd-b"}],"css":"amc-v-box amc-scroll-flex"}],"onkeydown":"onKeyDown()","css":"amc-body"}]},"format":"JSON","tplVersion":"5.3.4"}